#
# Alertas Sonoros
#
- alias: "Falar Temperatura ao ligar Ar"
  initial_state: on
  trigger:
  - platform: state
    entity_id: climate.climatizador
    from: 'off'
    to: 'auto'
  action:
  - service: tts.google_say
    data_template:
      entity_id: media_player.google_home
      message: 'Temperatura externa é de {{ states.sensor.dark_sky_temperature.state | int }} graus.'

- alias: "Porta entrada aberta"
  hide_entity: false
  initial_state: off
  trigger:
  - platform: state
    entity_id: binary_sensor.porta_entrada
    from: 'off'
    to: 'on'
  action:
  - service: tts.google_say
    data_template:
      entity_id: media_player.google_home
      message: Seja bem vindo.
  - delay:
      milliseconds: 600
  - service: camera.snapshot
    data:
      entity_id: camera.camera_interna
      filename: '/tmp/snapshot.jpg'
  - service: notify.telegramtodos
    data:
      message: Capturado!
      data:
        photo:
          - file: "/tmp/snapshot.jpg"
            caption: Interna


#
# Notificações Telegram
#
- alias: 'Notificação: Luzez On/Off'
  initial_state: off
  trigger:
  - entity_id:
      - light.garagem
      - light.arandelas
      - light.arandelas_da_varanda
      - light.area_da_piscina
      - light.refretores_piscina
      - light.entrada
      - light.varanda_fundos
      - light.postes
      - light.lavanderia
      - light.banheiro_da_suite
      - light.banheiro_social
      - light.lavabo
      - llight.cozinha
      - light.pia
      - light.bebedor
      - light.pendentes
      - light.sala_game
      - light.central
      - light.trilhos
      - light.bancada
      - light.jf
      - light.entrada_garagem
      - light.mesa_de_antar
      - light.lustre
      - light.sala_de_estar
      - light.quarto_da_frente
      - light.quarto_do_meio
      - light.corredor
      - light.quarto_da_suite
      #- light.abajur
      - light.yeelight_rgb_7c49eb15924b
      - light.closet
    from: 'off'
    platform: state
    to: 'on'
  - entity_id:
      - light.garagem
      - light.arandelas
      - light.arandelas_da_varanda
      - light.area_da_piscina
      - light.refretores_piscina
      - light.entrada
      - light.varanda_fundos
      - light.postes
      - light.lavanderia
      - light.banheiro_da_suite
      - light.banheiro_social
      - light.lavabo
      - llight.cozinha
      - light.pia
      - light.bebedor
      - light.pendentes
      - light.sala_game
      - light.central
      - light.trilhos
      - light.bancada
      - light.jf
      - light.entrada_garagem
      - light.mesa_de_antar
      - light.lustre
      - light.sala_de_estar
      - light.quarto_da_frente
      - light.quarto_do_meio
      - light.corredor
      - light.quarto_da_suite
      #- light.abajur
      - light.yeelight_rgb_7c49eb15924b
      - light.closet
    from: 'on'
    platform: state
    to: 'off'
  action:
  - service: notify.telegramtodos
    data_template:
      message: >
        Luz: {{ trigger.to_state.attributes.friendly_name }} {{ trigger.to_state.state }}


- id: letsencrypt-renewal
  initial_state: 'on'
  alias: "Renova Let's Encrypt"
  trigger:
  - platform: time
    at: '00:00:00'
  action:
  - service: hassio.addon_restart
    data:
      addon: core_letsencrypt


#
# DESPERTADOR
#
- alias: "Conf. Despertador"
  hide_entity: false
  initial_state: 'on'
  trigger:
    platform: template
    value_template: '{{ states.sensor.time.state == states.sensor.alarm_clock_time_long.state }}'
  condition:
    condition: state
    entity_id: input_boolean.alarm_clock_status
    state: 'on'
  action:
  - service: media_player.volume_set
    data_template:
      entity_id: media_player.google_home
      volume_level: '{{ states.input_number.alarm_clock_volume.state }}'
  - service: tts.google_say
    entity_id: media_player.google_home
    data_template:
      message: '{{ states.input_text.text_clock.state }}'
  - delay:
      seconds: 6
  - service: tts.google_say
    data_template:
      entity_id: media_player.google_home
      message: 'Temperatura {{ states.sensor.dark_sky_temperature.state | int }} graus. A previsão para as próximas 24h é: {{ states.sensor.dark_sky_hourly_summary.state }} . E para os próximos dias será: {{ states.sensor.dark_sky_daily_summary.state }} '
  - delay:
      seconds: 30
  - service: media_extractor.play_media
    entity_id: media_player.google_home
    data_template:
      media_content_id: '{{ states.input_text.text_url_youtube.state }}'
      media_content_type: video/youtube

#
# ALARME
#
- alias: "Alarme - Notif. quando for ativado"
  hide_entity: false
  initial_state: 'on'
  trigger:
  - platform: state
    entity_id: alarm_control_panel.alarme_da_casa
    to: armed_away
  - platform: state
    entity_id: alarm_control_panel.alarme_da_casa
    to: armed_home
  action:
  - service: script.turn_on
    entity_id: script.reseta_sensores
  - service: switch.turn_on
    data:
      entity_id: switch.sirenes
  - service: switch.turn_off
    data:
      entity_id: switch.sirenes
  - service: notify.telegramtodos
    data:
      message: Alarme ativado {% if is_state('alarm_control_panel.alarme_da_casa',
        'armed_away') %}com delay de 10s.{% else %}instantaneamente.{% endif %}
  - service: media_player.volume_set
    data_template:
      entity_id: media_player.google_home
      volume_level: 0.3
  - service: media_player.volume_set
    data_template:
      entity_id: media_player.google_home_sala
      volume_level: 0.8
  - service: tts.google_say
    data_template:
      entity_id: media_player.google_home_sala
      message: Alarme ativado
  - service: tts.google_say
    data_template:
      entity_id: media_player.google_home
      message: Alarme ativado
  # Apaga todas as luzes
  - service: light.turn_off
    data:
      entity_id: group.all_lights

- alias: "Alarme - Aviso ativando em 10s"
  hide_entity: false
  initial_state: 'on'
  trigger:
  - platform: state
    entity_id: alarm_control_panel.alarme_da_casa
    to: pending
  action:
  - service: media_player.volume_set
    data_template:
      entity_id: media_player.google_home
      volume_level: 0.3
  - service: media_player.volume_set
    data_template:
      entity_id: media_player.google_home_sala
      volume_level: 0.8
  - service: tts.google_say
    data_template:
      entity_id: media_player.google_home
      message: Ativando alarme em 10 segundos.
  - service: tts.google_say
    data_template:
      entity_id: media_player.google_home_sala
      message: Ativando alarme em 10 segundos.
  - service: switch.turn_on
    data:
      entity_id: switch.sirenes
  - service: switch.turn_off
    data:
      entity_id: switch.sirenes

- alias: "Alarme - Aviso desativado"
  hide_entity: false
  initial_state: 'on'
  trigger:
  - platform: state
    entity_id: alarm_control_panel.alarme_da_casa
    to: disarmed
  action:
  - service: switch.turn_on
    data:
      entity_id: switch.sirenes
  - service: switch.turn_off
    data:
      entity_id: switch.Sirenes
  - service: notify.telegramtodos
    data:
      message: Alarme desativado!
  - service: media_player.volume_set
    data_template:
      entity_id: media_player.google_home
      volume_level: 0.3
  - service: media_player.volume_set
    data_template:
      entity_id: media_player.google_home_sala
      volume_level: 0.8
  - service: tts.google_say
    data_template:
      entity_id: media_player.google_home_sala
      message: Alarme desativado!
  - service: tts.google_say
    data_template:
      entity_id: media_player.google_home
      message: Alarme desativado!

- alias: "Alarme - Disparar (Armado em casa)"
  hide_entity: false
  initial_state: 'on'
  trigger:
  - platform: state
    entity_id:
      - binary_sensor.sala_social
      - binary_sensor.corredor
      - binary_sensor.porta_varanda
      - binary_sensor.porta_entrada
      - binary_sensor.porta_area
      - binary_sensor.janela_closet
      - binary_sensor.janela_cozinha
      - binary_sensor.janela_suite
      - binary_sensor.janela_quarto_f
      - binary_sensor.janela_quarto_m
    to: 'on'
  condition:
  - condition: state
    entity_id: alarm_control_panel.alarme_da_casa
    state: armed_home
  action:
  # Liga sirenes
  - service: switch.turn_on
    data:
      entity_id: switch.sirenes
  # Liga todas as luzes
  - service: light.turn_on
    data:
      entity_id:
        - group.all_lights
  - service: notify.telegramtodos
    data:
      message: Alarme disparou! (armed_home)
  # Envia Mensagem com ql sensor
  - service: notify.telegramtodos
    data_template:
      message: >
        Sensor: {{ trigger.to_state.attributes.friendly_name }}
  # Mensagem de audio nos google homes
  - service: media_player.volume_set
    data_template:
      entity_id: media_player.google_home
      volume_level: 0.5
  - service: tts.google_say
    data_template:
      entity_id: media_player.google_home
      message: Sensor {{ trigger.to_state.attributes.friendly_name }} violado. Pega a 12 que o filho da puta vai levar chumbo!
  - service: media_player.volume_set
    data_template:
      entity_id: media_player.google_home_sala
      volume_level: 0.8
  - service: tts.google_say
    data_template:
      entity_id: media_player.google_home_sala
      message: Sensor {{ trigger.to_state.attributes.friendly_name }} violado. Pega a 12 que o filho da puta vai levar chumbo!
  # Captura imagens das cameras
  - service: camera.snapshot
    data:
      entity_id: camera.camera_interna
      filename: '/tmp/snapshot1a.jpg'
  #- service: camera.snapshot
    #data:
      #entity_id: camera.wanscam_360
      #filename: '/tmp/snapshot2a.jpg'
  # Envia imagens capturadas
  - service: notify.telegramtodos
    data:
      message: ""
      data:
        photo:
          - file: "/tmp/snapshot1a.jpg"
            caption: Interna
          #- file: "/tmp/snapshot2a.jpg"
          #  caption: Garagem
  - service: script.turn_on
    entity_id: script.foto_cam

- alias: "Alarme - Disparar (Sem ninguém)"
  hide_entity: false
  initial_state: 'on'
  trigger:
  - platform: state
    entity_id:
      - binary_sensor.Sala_Social
      - binary_sensor.corredor
      - binary_sensor.Porta_Varanda
      - binary_sensor.Porta_Entrada
      - binary_sensor.Porta_Area
      - binary_sensor.Janela_Closet
      - binary_sensor.Janela_Cozinha
      - binary_sensor.Janela_Suite
      - binary_sensor.Janela_Quarto_F
      - binary_sensor.Janela_Quarto_M
    to: 'on'
  condition:
  - condition: state
    entity_id: alarm_control_panel.alarme_da_casa
    state: armed_away
  action:
  # Liga sirenes
  - service: switch.turn_on
    data:
      entity_id: switch.sirenes
  # Liga todas as luzes
  - service: light.turn_on
    data:
      entity_id:
        - group.all_lights
  - service: notify.telegramtodos
    data:
      message: Alarme disparou! (armed_away)
  # Envia Mensagem com ql sensor
  - service: notify.telegramtodos
    data_template:
      message: >
        Sensor: {{ trigger.to_state.attributes.friendly_name }}
  # Mensagem de audio nos google homes
  - service: media_player.volume_set
    data_template:
      entity_id: media_player.google_home
      volume_level: 0.5
  - service: tts.google_say
    data_template:
      entity_id: media_player.google_home
      message: Sensor {{ trigger.to_state.attributes.friendly_name }} violado. Pega a 12 que o filho da puta vai levar chumbo!
  - service: media_player.volume_set
    data_template:
      entity_id: media_player.google_home_sala
      volume_level: 0.5
  - service: tts.google_say
    data_template:
      entity_id: media_player.google_home_sala
      message: Sensor {{ trigger.to_state.attributes.friendly_name }} violado. Pega a 12 que o filho da puta vai levar chumbo!
  # Captura imagens das cameras
  - service: camera.snapshot
    data:
      entity_id: camera.camera_interna
      filename: '/tmp/snapshot1a.jpg'
  #- service: camera.snapshot
    #data:
      #entity_id: camera.wanscam_360
      #filename: '/tmp/snapshot2a.jpg'
  # Envia imagens capturadas
  - service: notify.telegramtodos
    data:
      message: ""
      data:
        photo:
          - file: "/tmp/snapshot1a.jpg"
            caption: Interna
          #- file: "/tmp/snapshot2a.jpg"
          #  caption: Garagem
  - service: script.turn_on
    entity_id: script.foto_cam

- alias: "Alarme - Desliga sirene ao desativar"
  hide_entity: false
  initial_state: 'on'
  trigger:
  - platform: state
    entity_id: alarm_control_panel.alarme_da_casa
    to: disarmed
  action:
  - service: switch.turn_off
    data:
      entity_id: switch.Sirenes

#
# CONTROLES DIGOO
# ACOES

# Controle 1
- alias: Controle (1) - Armar
  hide_entity: true
  initial_state: 'on'
  trigger:
  - platform: state
    entity_id: binary_sensor.c1_alarme
    from: 'off'
    to: 'on'
  action:
  - service: alarm_control_panel.alarm_arm_away
    data:
      entity_id: alarm_control_panel.alarme_da_casa
      code: 123

- alias: Controle (1) - Desarmar
  hide_entity: true
  initial_state: 'on'
  trigger:
  - platform: state
    entity_id: binary_sensor.c1_alarme
    from: 'on'
    to: 'off'
  action:
  - service: alarm_control_panel.alarm_disarm
    data:
      entity_id: alarm_control_panel.alarme_da_casa
      code: 123
#  - service: mqtt.publish
#    data:
#      topic: "tele/sonoffBr1/RESULT"
#      payload: "921052"
#  - service: mqtt.publish
#    data:
#      topic: "tele/sonoffBr1/RESULT"
#      payload: "77B0D2"

# Controle 2
- alias: Controle (2) - Armar
  hide_entity: true
  initial_state: 'on'
  trigger:
  - platform: state
    entity_id: binary_sensor.c2_alarme
    from: 'off'
    to: 'on'
  action:
  - service: alarm_control_panel.alarm_arm_away
    data:
      entity_id: alarm_control_panel.alarme_da_casa
      code: 123

- alias: Controle (2) - Desarmar
  hide_entity: true
  initial_state: 'on'
  trigger:
  - platform: state
    entity_id: binary_sensor.c2_alarme
    from: 'on'
    to: 'off'
  action:
  - service: alarm_control_panel.alarm_disarm
    data:
      entity_id: alarm_control_panel.alarme_da_casa
      code: 123
#  - service: mqtt.publish
#    data:
#      topic: "tele/sonoffBr1/RESULT"
#      payload: "2970D2"
#  - service: mqtt.publish
#    data:
#      topic: "tele/sonoffBr1/RESULT"
#      payload: "921052"

# Controle 3
- alias: Controle (3) - Armar
  hide_entity: true
  initial_state: 'on'
  trigger:
  - platform: state
    entity_id: binary_sensor.c3_alarme
    from: 'off'
    to: 'on'
  action:
  - service: alarm_control_panel.alarm_arm_away
    data:
      entity_id: alarm_control_panel.alarme_da_casa
      code: 123

- alias: Controle (3) - Desarmar
  hide_entity: true
  initial_state: 'on'
  trigger:
  - platform: state
    entity_id: binary_sensor.c3_alarme
    from: 'on'
    to: 'off'
  action:
  - service: alarm_control_panel.alarm_disarm
    data:
      entity_id: alarm_control_panel.alarme_da_casa
      code: 123
#  - service: mqtt.publish
#    data:
#      topic: "tele/sonoffBr1/RESULT"
#      payload: "2970D2"
#  - service: mqtt.publish
#    data:
#      topic: "tele/sonoffBr1/RESULT"
#      payload: "77B0D2"


# Reseta botões Home/SOS Controle 1
- alias: Controle (1) - Auto 1s Btn Home
  hide_entity: true
  initial_state: 'on'
  trigger:
  - platform: state
    entity_id: binary_sensor.c1_home
    from: 'off'
    to: 'on'
    for:
      seconds: 1
  action:
  - service: mqtt.publish
    data:
      topic: "tele/sonoffBr1/RESULT"
      payload: ' {"RfReceived":{"Data":"2970D4off"}} '

- alias: Controle (1) - Auto 1s Btn SOS
  hide_entity: true
  initial_state: 'on'
  trigger:
  - platform: state
    entity_id: binary_sensor.c1_sos
    from: 'off'
    to: 'on'
    for:
      seconds: 1
  action:
  - service: mqtt.publish
    data:
      topic: "tele/sonoffBr1/RESULT"
      payload: ' {"RfReceived":{"Data":"2970D8off"}} '

# Reseta botões Home/SOS Controle 2
- alias: Controle (2) - Auto 1s Btn Home
  hide_entity: true
  initial_state: 'on'
  trigger:
  - platform: state
    entity_id: binary_sensor.c2_home
    from: 'off'
    to: 'on'
    for:
      seconds: 1
  action:
  - service: mqtt.publish
    data:
      topic: "tele/sonoffBr1/RESULT"
      payload: ' {"RfReceived":{"Data":"921054off"}} '

- alias: Controle (2) - Auto 1s Btn SOS
  hide_entity: true
  initial_state: 'on'
  trigger:
  - platform: state
    entity_id: binary_sensor.c2_sos
    from: 'off'
    to: 'on'
    for:
      seconds: 1
  action:
  - service: mqtt.publish
    data:
      topic: "tele/sonoffBr1/RESULT"
      payload: ' {"RfReceived":{"Data":"921058off"}} '

# Reseta botões Home/SOS Controle 3
- alias: Controle (3) - Auto 1s Btn Home
  hide_entity: true
  initial_state: 'on'
  trigger:
  - platform: state
    entity_id: binary_sensor.c3_home
    from: 'off'
    to: 'on'
    for:
      seconds: 1
  action:
  - service: mqtt.publish
    data:
      topic: "tele/sonoffBr1/RESULT"
      payload: ' {"RfReceived":{"Data":"77B0D4off"}} '

- alias: Controle (3) - Auto 1s Btn SOS
  hide_entity: true
  initial_state: 'on'
  trigger:
  - platform: state
    entity_id: binary_sensor.c3_sos
    from: 'off'
    to: 'on'
    for:
      seconds: 1
  action:
  - service: mqtt.publish
    data:
      topic: "tele/sonoffBr1/RESULT"
      payload: ' {"RfReceived":{"Data":"77B0D8off"}} '

#
# Ações Home/SOS Controles
#
# SOS
- alias: Controle (1) - Btn SOS
  hide_entity: true
  initial_state: 'on'
  trigger:
  - platform: state
    entity_id: binary_sensor.c1_sos
    from: 'off'
    to: 'on'
  action:
# ... programar algo ...
  - service: notify.telegramrudi
    data:
      message: SOS!! Controle 1 está em perigo.
  - service: switch.turn_on
    data:
      entity_id: switch.sonoff
  - service: tts.google_say
    data_template:
      entity_id: media_player.google_home
      message: SOS!! Controle 1 está em perigo.

- alias: Controle (2) - Btn SOS
  hide_entity: true
  initial_state: 'on'
  trigger:
  - platform: state
    entity_id: binary_sensor.c2_sos
    from: 'off'
    to: 'on'
  action:
# ... programar algo ...
  - service: notify.telegramrudi
    data:
      message: SOS!! Controle 2 está em perigo.
  - service: switch.turn_on
    data:
      entity_id: switch.sonoff
  - service: tts.google_say
    data_template:
      entity_id: media_player.google_home
      message: SOS!! Controle 2 está em perigo.

- alias: Controle (3) - Btn SOS
  hide_entity: true
  initial_state: 'on'
  trigger:
  - platform: state
    entity_id: binary_sensor.c3_sos
    from: 'off'
    to: 'on'
  action:
# ... programar algo ...
  - service: notify.telegramrudi
    data:
      message: SOS!! Controle 3 está em perigo.
  - service: switch.turn_on
    data:
      entity_id: switch.sonoff
  - service: tts.google_say
    data_template:
      entity_id: media_player.google_home
      message: SOS!! Controle 3 está em perigo.

# HOME
- alias: Controle (1) - Btn Home
  hide_entity: true
  initial_state: 'on'
  trigger:
  - platform: state
    entity_id: binary_sensor.c1_home
    from: 'off'
    to: 'on'
  action:
# ... programar algo ...
  - service: notify.telegramrudi
    data:
      message: Botão home acionado no controle 1.
  - service: switch.turn_on
    data:
      entity_id: switch.Suite
  - service: tts.google_say
    data_template:
      entity_id: media_player.google_home
      message: Botão home acionado no controle 1.

# Liga luz do abajur
- alias: Controle (2) - Btn Home
  hide_entity: true
  initial_state: 'on'
  trigger:
  - platform: state
    entity_id: binary_sensor.c2_home
    from: 'off'
    to: 'on'
  action:
  - service: light.turn_on
    data:
      entity_id: light.yeelight_rgb_7c49eb15924b
# ... programar algo ...
#  - service: notify.telegramrudi
#    data:
#      message: Botão home acionado no controle 2.
#  - service: switch.turn_on
#    data:
#      entity_id: switch.Suite
#  - service: tts.voicerss_say
#    data_template:
#      entity_id: media_player.google_home
#      message: Botão home acionado no controle 2.

- alias: Controle (3) - Bt Home (Liga abajur)
  hide_entity: true
  initial_state: 'on'
  trigger:
  - platform: state
    entity_id: binary_sensor.c3_home
    from: 'off'
    to: 'on'
  condition:
    condition: state
    entity_id: light.yeelight_rgb_7c49eb15924b
    state: 'off'
  action:
  - service: light.turn_on
    data:
      entity_id: light.yeelight_rgb_7c49eb15924b
      transition: 3

- alias: Controle (3) - Bt Home (Desligar abajur)
  hide_entity: true
  initial_state: 'on'
  trigger:
  - platform: state
    entity_id: binary_sensor.c3_home
    from: 'off'
    to: 'on'
  condition:
    condition: state
    entity_id: light.yeelight_rgb_7c49eb15924b
    state: 'on'
  action:
  - service: light.turn_off
    data:
      entity_id: light.yeelight_rgb_7c49eb15924b
      transition: 3



# ... programar algo ...
#  - service: notify.telegramrudi
#    data:
#      message: Botão home acionado no controle 3.
#  - service: switch.turn_on
#    data:
#      entity_id: switch.Suite
#  - service: tts.voicerss_say
#    data_template:
#      entity_id: media_player.google_home
#      message: Botão home acionado no controle 3.

#
# SENSORES FECHAMENTO AUTOMATICO
#
- alias: "FS.W Quarto M"
  hide_entity: true
  initial_state: 'on'
  trigger:
  - platform: state
    entity_id: binary_sensor.janela_quarto_m
    from: 'off'
    to: 'on'
    for:
      seconds: 2
  action:
  - service: mqtt.publish
    data:
      topic: "tele/sonoffBr1/RESULT"
      payload: ' {"RfReceived":{"Data":"996D46off"}} '
- alias: "FS.W Quarto F"
  hide_entity: true
  initial_state: 'on'
  trigger:
  - platform: state
    entity_id: binary_sensor.janela_quarto_f
    from: 'off'
    to: 'on'
    for:
      seconds: 2
  action:
  - service: mqtt.publish
    data:
      topic: "tele/sonoffBr1/RESULT"
      payload: ' {"RfReceived":{"Data":"CD5B46off"}} '
- alias: "FS.W Suite"
  hide_entity: true
  initial_state: 'on'
  trigger:
  - platform: state
    entity_id: binary_sensor.janela_suite
    from: 'off'
    to: 'on'
    for:
      seconds: 2
  action:
  - service: mqtt.publish
    data:
      topic: "tele/sonoffBr1/RESULT"
      payload: ' {"RfReceived":{"Data":"B92D46off"}} '
- alias: "FS.D Varanda"
  hide_entity: true
  initial_state: 'on'
  trigger:
  - platform: state
    entity_id: binary_sensor.porta_varanda
    from: 'off'
    to: 'on'
    for:
      seconds: 2
  action:
  - service: mqtt.publish
    data:
      topic: "tele/sonoffBr1/RESULT"
      payload: ' {"RfReceived":{"Data":"5E6B46off"}} '
- alias: "FS.W Cozinha"
  hide_entity: true
  initial_state: 'on'
  trigger:
  - platform: state
    entity_id: binary_sensor.janela_cozinha
    from: 'off'
    to: 'on'
    for:
      seconds: 2
  action:
  - service: mqtt.publish
    data:
      topic: "tele/sonoffBr1/RESULT"
      payload: ' {"RfReceived":{"Data":"C41B46off"}} '
- alias: "FS.P Sala Social"
  hide_entity: true
  initial_state: 'on'
  trigger:
  - platform: state
    entity_id: binary_sensor.sala_social
    from: 'off'
    to: 'on'
    for:
      seconds: 2
  action:
  - service: mqtt.publish
    data:
      topic: "tele/sonoffBr1/RESULT"
      payload: ' {"RfReceived":{"Data":"9B5086off"}} '
- alias: "FS.P Corredor"
  hide_entity: true
  initial_state: 'on'
  trigger:
  - platform: state
    entity_id: binary_sensor.corredor
    from: 'off'
    to: 'on'
    for:
      seconds: 2
  action:
  - service: mqtt.publish
    data:
      topic: "tele/sonoffBr1/RESULT"
      payload: ' {"RfReceived":{"Data":"82C186off"}} '

- alias: "FS.P Ext Piscina"
  hide_entity: true
  initial_state: 'on'
  trigger:
  - platform: state
    entity_id: binary_sensor.ext_piscina
    from: 'off'
    to: 'on'
    for:
      seconds: 2
  action:
  - service: mqtt.publish
    data:
      topic: "tele/sonoffBr1/RESULT"
      payload: ' {"RfReceived":{"Data":"EE4986off"}} '
- alias: "FS.P Ext Garagem"
  hide_entity: true
  initial_state: 'on'
  trigger:
  - platform: state
    entity_id: binary_sensor.ext_garagem
    from: 'off'
    to: 'on'
    for:
      seconds: 2
  action:
  - service: mqtt.publish
    data:
      topic: "tele/sonoffBr1/RESULT"
      payload: ' {"RfReceived":{"Data":"AAC186off"}} '
- alias: "FS.W Sala Jantar"
  hide_entity: true
  initial_state: 'on'
  trigger:
  - platform: state
    entity_id: binary_sensor.sala_jantar
    from: 'off'
    to: 'on'
    for:
      seconds: 2
  action:
  - service: mqtt.publish
    data:
      topic: "tele/sonoffBr1/RESULT"
      payload: ' {"RfReceived":{"Data":"55A486off"}} '
- alias: "FS.D Entrada"
  hide_entity: true
  initial_state: 'on'
  trigger:
  - platform: state
    entity_id: binary_sensor.porta_entrada
    from: 'off'
    to: 'on'
    for:
      seconds: 2
  action:
  - service: mqtt.publish
    data:
      topic: "tele/sonoffBr1/RESULT"
      payload: ' {"RfReceived":{"Data":"2E9D46off"}} '
- alias: "FS.W Closet"
  hide_entity: true
  initial_state: 'on'
  trigger:
  - platform: state
    entity_id: binary_sensor.janela_closet
    from: 'off'
    to: 'on'
    for:
      seconds: 2
  action:
  - service: mqtt.publish
    data:
      topic: "tele/sonoffBr1/RESULT"
      payload: ' {"RfReceived":{"Data":"7F7D46off"}} '
- alias: "FS.D Area"
  hide_entity: true
  initial_state: 'on'
  trigger:
  - platform: state
    entity_id: binary_sensor.porta_area
    from: 'off'
    to: 'on'
    for:
      seconds: 2
  action:
  - service: mqtt.publish
    data:
      topic: "tele/sonoffBr1/RESULT"
      payload: ' {"RfReceived":{"Data":"09D8C6off"}} '


#
# LUZES
#

- alias: Luz Sem desligar - Banheiro Suite
  hide_entity: false
  initial_state: true
  trigger:
    platform: state
    entity_id: light.banheiro_da_suite
    from: 'off'
    to: 'on'
    for:
      minutes: 30
  action:
  - service: light.turn_off
    entity_id: light.banheiro_da_suite
  - service: tts.google_say
    data_template:
      entity_id: media_player.google_home
      message: "Oops! Desliguei a luz do banheiro da suíte. Estava ligada por muito tempo. Vamos poupar luz que aqui ninguém é dono da RGE."
  - service: tts.google_say
    data_template:
      entity_id: media_player.google_home_sala
      message: "Oops! Desliguei a luz do banheiro da suíte. Estava ligada por muito tempo. Vamos poupar luz que aqui ninguém é dono da RGE."

- alias: Luz Sem desligar - Banheiro Social
  hide_entity: false
  initial_state: true
  trigger:
    platform: state
    entity_id: light.banheiro_social
    from: 'off'
    to: 'on'
    for:
      minutes: 30
  action:
  - service: light.turn_off
    entity_id: light.banheiro_social
  - service: tts.google_say
    data_template:
      entity_id: media_player.google_home
      message: "Oops! Desliguei a luz do banheiro Social. Estava ligada por muito tempo. Vamos poupar luz que aqui ninguém é dono da RGE."
  - service: tts.google_say
    data_template:
      entity_id: media_player.google_home_sala
      message: "Oops! Desliguei a luz do banheiro Social. Estava ligada por muito tempo. Vamos poupar luz que aqui ninguém é dono da RGE."

- alias: Luz Sem desligar - Lavabo
  hide_entity: false
  initial_state: true
  trigger:
    platform: state
    entity_id: light.lavabo
    from: 'off'
    to: 'on'
    for:
      minutes: 10
  action:
  - service: light.turn_off
    entity_id: light.lavabo
  - service: tts.google_say
    data_template:
      entity_id: media_player.google_home
      message: "Oops! Desliguei a luz do lavabo. Estava ligada por muito tempo. Vamos poupar luz que aqui ninguém é dono da RGE."
  - service: tts.google_say
    data_template:
      entity_id: media_player.google_home_sala
      message: "Oops! Desliguei a luz do lavabo. Estava ligada por muito tempo. Vamos poupar luz que aqui ninguém é dono da RGE."

- alias: Luz Corredor Liga - 18:30h as 07:30 (Movimento)
  hide_entity: false
  initial_state: true
  trigger:
    platform: state
    entity_id: binary_sensor.corredor
    from: 'off'
    to: 'on'
  condition:
    condition: time
    after: '18:30:00'
    before: '07:30:00'
  action:
    service: light.turn_on
    entity_id: light.corredor

- alias: Luz Corredor Desliga - (S/Movimento 2min)
  hide_entity: false
  initial_state: true
  trigger:
    platform: state
    entity_id: binary_sensor.corredor
    to: 'off'
    for:
      minutes: 2
  condition:
    condition: time
    after: '18:00:00'
    before: '07:30:00'
  action:
    service: light.turn_off
    entity_id: light.corredor

- alias: "Luz Arandelas - Ligar"
  hide_entity: false
  initial_state: 'off'
  trigger:
    platform: template
    value_template: '{{ states.sensor.time.state == states.sensor.anoiteceu.state }}'
  condition:
  action:
  - service: light.turn_on
    data:
      entity_id:
        - light.arandelas
        - light.arandelas_da_varanda


- alias: "Luz Arandelas - Desligar"
  hide_entity: false
  initial_state: 'on'
  trigger:
#    - platform: time
#      at: '23:00:00'
    platform: template
    value_template: "{{ states('sensor.time') == (states.input_datetime.arandelas_off.attributes.timestamp | int | timestamp_custom('%H:%M', False)) }}"
  action:
  - service: light.turn_off
    data:
      entity_id:
        - light.arandelas
        - light.arandelas_da_varanda

- alias: "Luz Postes - Ligar"
  hide_entity: false
  initial_state: 'on'
  trigger:
    platform: template
    value_template: '{{ states.sensor.time.state == states.sensor.anoiteceu.state }}'
  condition:
  action:
  - service: light.turn_on
    data:
      entity_id:
        - light.postes

- alias: "Luz Postes - Desligar"
  hide_entity: false
  initial_state: 'on'
  trigger:
    platform: template
    value_template: "{{ states('sensor.time') == (states.input_datetime.poste_off.attributes.timestamp | int | timestamp_custom('%H:%M', False)) }}"
  action:
  - service: light.turn_off
    data:
      entity_id:
        - light.postes


# MOVIMENTO SUSPEITOS COM ALARME ATIVO

- alias: "Piscina (Alarme ON) - Movimento"
  hide_entity: false
  initial_state: 'on'
  trigger:
  - platform: state
    entity_id: binary_sensor.ext_piscina
    from: 'off'
    to: 'on'
  condition:
  - condition: state
    entity_id: alarm_control_panel.alarme_da_casa
    state: armed_away
  action:
  # Envia Mensagem
  - service: notify.telegramtodos
    data:
      message: "Movimento na área da piscina"
  # Captura imagens das cameras
  - service: camera.snapshot
    data:
      entity_id: camera.camera_interna
      filename: '/tmp/snapshot1a.jpg'
  #- service: camera.snapshot
    #data:
      #entity_id: camera.wanscam_360
      #filename: '/tmp/snapshot2a.jpg'
  # Envia imagens
  - service: notify.telegramtodos
    data:
      message: ""
      data:
        photo:
          - file: "/tmp/snapshot1a.jpg"
            caption: Interna
          #- file: "/tmp/snapshot2a.jpg"
            #caption: Garagem
  - service: script.turn_on
    entity_id: script.foto_cam

# Liga a luz se alarme ativado a noite (Garagem)
- alias: "Piscina (Alarme ON) - Luz (Movimento)"
  hide_entity: false
  initial_state: 'on'
  trigger:
  - entity_id: binary_sensor.ext_piscina
    from: 'off'
    platform: state
    to: 'on'
  condition:
  # Alarme ativo
  - condition: state
    entity_id: alarm_control_panel.alarme_da_casa
    state: armed_away
  - before: sunset
    condition: sun
  action:
  - service: light.turn_on
    data:
      entity_id:
        - light.area_da_piscina
        - light.postes

# Desliga a luz se nao tiver movimento com alarme ativo
- alias: "Piscina (Alarme ON) - Luz (S/Movimento)"
  hide_entity: false
  initial_state: 'on'
  trigger:
    platform: state
    entity_id: binary_sensor.ext_piscina
    to: 'off'
    for:
      minutes: 2
  condition:
  - condition: state
    entity_id: alarm_control_panel.alarme_da_casa
    state: armed_away
  action:
    service: light.turn_off
    data:
      entity_id:
        - light.area_da_piscina
        - light.postes


# Movimento Garagem
- alias: "Garagem (Alarme ON) - Movimento"
  hide_entity: false
  initial_state: 'on'
  trigger:
  - platform: state
    entity_id: binary_sensor.ext_garagem
    from: 'off'
    to: 'on'
  condition:
  - condition: state
    entity_id: alarm_control_panel.alarme_da_casa
    state: armed_away
  action:
  # Envia Mensagem
  - service: notify.telegramtodos
    data:
      message: "Movimento Garagem"
  # Captura imagens das cameras
  - service: camera.snapshot
    data:
      entity_id: camera.camera_interna
      filename: '/tmp/snapshot1a.jpg'
  #- service: camera.snapshot
    #data:
      #entity_id: camera.wanscam_360
      #filename: '/tmp/snapshot2a.jpg'
  # Envia imagens
  - service: notify.telegramtodos
    data:
      message: ""
      data:
        photo:
          - file: "/tmp/snapshot1a.jpg"
            caption: Interna
          #- file: "/tmp/snapshot2a.jpg"
          #  caption: Garagem
  - service: script.turn_on
    entity_id: script.foto_cam

# Liga a luz se alarme ativado a noite (Garagem)
- alias: "Garagem (Alarme ON) - Luz (Movimento)"
  hide_entity: false
  initial_state: 'on'
  trigger:
  - entity_id: binary_sensor.ext_garagem
    from: 'off'
    platform: state
    to: 'on'
  condition:
  # Alarme ativo
  - condition: state
    entity_id: alarm_control_panel.alarme_da_casa
    state: armed_away
  - before: sunset
    condition: sun
  action:
  - service: light.turn_on
    data:
      entity_id:
        - light.garagem
        - light.postes

# Desliga a luz se nao tiver movimento com alarme ativo
- alias: "Garagem (Alarme ON) - Luz (S/Movimento)"
  hide_entity: false
  initial_state: 'on'
  trigger:
    platform: state
    entity_id: binary_sensor.ext_garagem
    to: 'off'
    for:
      minutes: 2
  condition:
  - condition: state
    entity_id: alarm_control_panel.alarme_da_casa
    state: armed_away
  action:
    service: light.turn_off
    data:
      entity_id:
        - light.garagem
        - light.postes


# MOVIMENTOS EXTERNOS ALARME DESATIVADO/OFF.

- alias: "Piscina (Alarme OFF) - Movimento"
  hide_entity: false
  initial_state: 'on'
  trigger:
  - platform: state
    entity_id: binary_sensor.ext_piscina
    from: 'off'
    to: 'on'
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: alarm_control_panel.alarme_da_casa
        state: disarmed
      - condition: or
        # Não ter ninguem em casa
        conditions:
          - condition: state
            entity_id: group.all_devices
            state: 'not_home'
          - condition: state
            entity_id: group.all_devices
            state: 'unknown'
  action:
  # Envia Mensagem
  - service: notify.telegramtodos
    data:
      message: "Movimento na área da piscina"
  # Captura imagens das cameras
  - service: camera.snapshot
    data:
      entity_id: camera.camera_interna
      filename: '/tmp/snapshot1a.jpg'
  # Envia imagens
  - service: notify.telegramtodos
    data:
      message: ""
      data:
        photo:
          - file: "/tmp/snapshot1a.jpg"
            caption: Interna
  - service: script.turn_on
    entity_id: script.foto_cam

- alias: "Garagem (Alarme OFF) - Movimento"
  hide_entity: false
  initial_state: 'on'
  trigger:
  - platform: state
    entity_id: binary_sensor.ext_garagem
    from: 'off'
    to: 'on'
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: alarm_control_panel.alarme_da_casa
        state: disarmed
      - condition: or
        # Não ter ninguem em casa
        conditions:
          - condition: state
            entity_id: group.all_devices
            state: 'not_home'
          - condition: state
            entity_id: group.all_devices
            state: 'unknown'
  action:
  # Envia Mensagem
  - service: notify.telegramtodos
    data:
      message: "Movimento na garagem"
  - service: camera.snapshot
    data:
      entity_id: camera.camera_interna
      filename: '/tmp/snapshot2b.jpg'
  # Envia imagens
  - service: script.turn_on
    entity_id: script.foto_cam
  - service: notify.telegramtodos
    data:
      message: ""
      data:
        photo:
          - file: "/tmp/snapshot2b.jpg"
            caption: Interna


- alias: "Alarme - Testar Sensores"
  hide_entity: false
  initial_state: off
  trigger:
  - platform: state
    entity_id:
      - binary_sensor.sala_social
      - binary_sensor.sala_jantar
      - binary_sensor.corredor
      - binary_sensor.ext_garagem
      - binary_sensor.ext_piscina
      - binary_sensor.porta_varanda
      - binary_sensor.porta_entrada
      - binary_sensor.porta_area
      - binary_sensor.janela_closet
      - binary_sensor.janela_cozinha
      - binary_sensor.janela_suite
      - binary_sensor.janela_quarto_f
      - binary_sensor.janela_quarto_m
    to: 'on'
  action:
  - service: notify.telegramrudi
    data_template:
      message: >
        [OK] : {{ trigger.to_state.attributes.friendly_name }}